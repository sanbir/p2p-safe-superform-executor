import assert from 'node:assert/strict'
import test from 'node:test'
import { decodeFunctionData } from 'viem'

import { p2pSuperformProxyAbi } from '../src/utils/abis'
import {
  buildProxyBatchClaimCalldata,
  decodeRewardsDistributorBatchClaim,
  fetchProtocolRewardsClaim,
  parseProtocolRewardsClaimResponse
} from '../src/utils/rewards'

const exampleResponse = {
  transactionData:
    '0x47575953000000000000000000000000e1158d9158d41186994b400ab833b85284f2e06c00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000baa5cc21fd487b8fcc2f632f3f4e8d37262a08420000000000000000000000000000000000000000000000000000000000000001000000000000000000000000e08e1f00d388e201e48842e53fa96195568e681300000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000028af16b3ab100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000001825d672f90000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000bc7d636142397f5954adf2cea4643a7d5dcdabec6168315655ae4634419f1e7099c9f0576e34ffe0885b6ff42939670ccdab5f7d34862bd498ac5f395bfd6cd299852a9aeacac9d4cb45bb61bae4ee068ba516fbae16e876675da00cad1aed3f982273e384655fca7e57bcf3352fbc824a2e710ad1bb03b17c7e5ab8423902d54459a220547ae3ff0120ea1748aabfc2fa1f3f2c23d14c0f8a0a90c3708f4aecc8eda73347da0e3e1eed5f839af3e2fac82c9a42a25af6c13ff44cc89d02b60f25d280e1ec3d4284a285b38b6cba3f1a3c680b578c679e98d66e5a406b6b9d2c6022f5eeddda9e39f09b7d9c3d2628f36b2ed24b8d5a0d1960804c57f29a509a042445114630c6862ac84c95d3e5a88a12f7003ff4062296867c4de52485b8e2e1b87a80207bdc552b222021707871fe9b3a7793dbc59819ef7337495e2e83abd77a753bb38670af8389fd3f9d729be9bc9d62a786da1cf642e6afafdfab79249000000000000000000000000000000000000000000000000000000000000000d3c50c1afd306ddcee2966ac1438f3268d60fee24ef62caf194d2db4847c3bec21a5b49594d65a9d1bff5786157c340d595c45b33cd7b54754b0d26291c315ffed3533d1f5dfada82a099096ef04a9bc959ceadbeb5535f042271941d7e504eb5d8898135c6ba22d1fdfa3e65aa4a94c6f407df1e9437719c4249da733247b137f64423b8c4f61389fcd0cbc8623d1b7ea8b954fcc20c776b5eada9e979ffb68dad077774a36c635d0706ea88bc4e6613eeff47c4831865ea43799d4a63a93d9e0a16257095bc9fa5fb3d0f3633e99cba2ba8e736bd2efc15d89437b343fee688641d6979df6ce12b1b4c6d86961a70be564dd43dc2b80ee3f7719b7fde5cfbf0064dfe3838e0bbd2b635c5c9fb714d3a5ec35de1691abfce7adadc833cc4c1e36f1c4145ec93293e68656041ed2f71aad065a2a8f10d4326e29d5fc245950b45e681527e3326fa861f1d8d172b6ae8df5230db624af6cf9ccb81b51bf2268557c7b4def6283c2f789d08ada5c3797c8b4c7212cf4235f40b743db448f98680bb936957bdde2c9dd3a23b98ffe6230a122e4c645d570804034b2788d59e59875b',
  to: '0xce23bD7205bF2B543F6B4eeC00Add0C111FEFc3B'
}

const exampleProxy = '0xe1158d9158d41186994b400ab833b85284f2e06c'

test('parse and decode claim response', () => {
  const parsed = parseProtocolRewardsClaimResponse(exampleResponse)
  assert.equal(parsed.to, '0xce23bD7205bF2B543F6B4eeC00Add0C111FEFc3B')
  const decoded = decodeRewardsDistributorBatchClaim(parsed.transactionData)
  assert.equal(decoded.receiver.toLowerCase(), exampleProxy.toLowerCase())
  assert.ok(decoded.periodIds.length > 0)
  assert.ok(decoded.rewardTokens[0][0].toLowerCase() === '0xbaa5cc21fd487b8fcc2f632f3f4e8d37262a0842')
})

test('proxy calldata round-trips through ABI', () => {
  const decoded = decodeRewardsDistributorBatchClaim(exampleResponse.transactionData as `0x${string}`)
  const { data } = buildProxyBatchClaimCalldata(decoded)
  const roundTrip = decodeFunctionData({
    abi: p2pSuperformProxyAbi,
    data
  })
  assert.equal(roundTrip.functionName, 'batchClaim')
  const [_periodIds, rewardTokens] = roundTrip.args as [bigint[], string[][], bigint[][], string[][]]
  assert.ok(_periodIds.length === decoded.periodIds.length)
  assert.ok(rewardTokens[0][0].toLowerCase() === '0xbaa5cc21fd487b8fcc2f632f3f4e8d37262a0842')
})

test('fetchProtocolRewardsClaim can be mocked', async () => {
  let called = false
  const mockFetch: typeof fetch = async (_url, _init) => {
    called = true
    return new Response(JSON.stringify(exampleResponse), {
      status: 200,
      headers: { 'content-type': 'application/json' }
    })
  }

  const result = await fetchProtocolRewardsClaim({
    chainId: 8453,
    user: exampleProxy as `0x${string}`,
    apiKey: 'test-key',
    fetcher: mockFetch
  })

  assert.ok(called)
  assert.equal(result.to, '0xce23bD7205bF2B543F6B4eeC00Add0C111FEFc3B')
})
